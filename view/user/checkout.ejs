<%- include('./includes/header') %>
    <%- include('./includes/navigation') %>

        <section class="mt-5 checkout_area section_gap">
            <div class="container">
                <% if (Cart[0]==null){%>
                    <h2>No Orders</h2>
                    <a class="genric-btn primary" href="/">Go to Home</a>
                <% } else { %>
                    <div class="billing_details">
                        <div class="row">
                            <div class="col-lg-7">
                                <h3>Delivery Address</h3>
                                <form class="row contact_form" id="checkout-form" novalidate="novalidate">
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="first" name="firstName"
                                            placeholder="First name" value="Abdul">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="last" name="lastName"
                                            placeholder="Last name" value="Rayif">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="number" name="number"
                                            placeholder="Phone number" value="9746402973">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="email" class="form-control" id="email" name="email"
                                            placeholder="Email Address" value="rayifvp336@gmail.com">
                                    </div>
                                    <div class="col-md-12 form-group p_star">
                                        <input type="text" class="form-control" id="House-name" name="houseName"
                                            placeholder="House Name/Company Name/House No."
                                            value="Packapeer Academy Pvt.Ltd">
                                    </div>
                                    <div class="col-md-12 form-group p_star">
                                        <input type="text" class="form-control" id="address" name="address"
                                            placeholder="Address" value="SDF building">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="city" name="city"
                                            placeholder="Town/City" value="Kakkanchery">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="district" name="district"
                                            placeholder="District" value="Malappuram">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="state" name="state" placeholder="State"
                                            value="Kerala">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="country" name="country"
                                            placeholder="Country" value="India">
                                    </div>
                                    <div class="col-md-6 form-group p_star">
                                        <input type="text" class="form-control" id="zip" name="pincode"
                                            placeholder="Pincode/ZIP" value="679101">
                                    </div>
    
                            </div>
                            <div class="col-lg-5">
                                <div class="order_box">
                                    <h2>Your Order</h2>
                                    <ul class="list">
                                        <li><a href="#">Products <span>Total</span></a></li>
                                        
                                        <% for(Product of Cart[0].Products){ %>
                                            <li><a href="#"><span class="float-left w-50">
                                                        <%=Product.ProductName%>
                                                    </span><span class=" float-left w-25">x<%=Product.Quantity%></span><span
                                                        class=" float-right w-25">Rs. <%=Product.Price%></span></a></li>
                                            <% } %>
                                    </ul>
                                    <ul class="list list_2">
                                        <li><a href="#">Total <span>Rs. <%=Cart[0].Subtotal%> </span></a></li>
                                    </ul>
    
                                    <hr class="mt-3 mb-3">
                                    <h2>Payment Method</h2>
                                    <div class="mt-3 mb-3">
                                        <input type="radio" id="NET-BANKING" name="paymentMethod" value="NET BANKING">
                                        <label for="NET-BANKING">NET BANKING</label><br>
                                        <input type="radio" id="PAY-ON-DELIVERY" name="paymentMethod"
                                            value="PAY ON DELIVERY">
                                        <label for="PAY-ON-DELIVERY">PAY ON DELIVERY</label><br>
                                    </div>
    
    
    
    
    
                                    <button class="primary-btn w-100" type="submit">Proceed to Pay</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                  
            </div>
        </section>


     
        <%- include('./includes/footer') %>

            
            <script>
                $('#checkout-form').submit((e) => {
                    e.preventDefault()
                    $.ajax({
                        url: '/placeOrder/?cartId=<%=Cart[0]._id%>',
                        method: 'post',
                        data: $('#checkout-form').serialize(),
                        success: (response) => {
                            if (response.payOnDelivery) {

                                Swal.fire({
                                    title: 'Order Placed Successfully',
                                    icon: 'success',
                                    showDenyButton: true,
                                    confirmButtonText: 'View Order',
                                    denyButtonText: `Continue Shopping`,
                                    toast: true,
                                }).then((result) => {
                                    /* Read more about isConfirmed, isDenied below */
                                    if (result.isConfirmed) {
                                        location.href = '/orders'
                                    } else if (result.isDenied) {
                                        location.href = '/'
                                    }
                                })
                            } else if (response.netBanking) {
                                console.log('test ok');
                                let razorpayOrderData = response.razorpayOrderData
                                let userOrderData = response.userOrderData

                                var options = {
                                    "key": "rzp_test_ZMiXSevX9pibAE", // Enter the Key ID generated from the Dashboard
                                    "amount": response.razorpayOrderData.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                                    "currency": "INR",
                                    "name": "Untitled Legacy",
                                    "description": "Test Transaction",
                                    "image": "https://example.com/your_logo",
                                    "order_id": response.razorpayOrderData.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                    "handler": function (response) {
                                        console.log(response);
                                        // alert(response.razorpay_payment_id);
                                        // alert(response.razorpay_order_id);
                                        // alert(response.razorpay_signature)
                                        verifyPayment(response,razorpayOrderData,userOrderData);

                                        
                                    },

                                    "prefill": {
                                        "name": "Gaurav Kumar",
                                        "email": "gaurav.kumar@example.com",
                                        "contact": "9999999999"
                                    },
                                    "notes": {
                                        "address": "Razorpay Corporate Office"
                                    },
                                    "theme": {
                                        "color": "#3399cc"
                                    }
                                };
                                
                                var rzp1 = new Razorpay(options);
                                
                                rzp1.on('payment.failed', function (response){
                                        paymentFailed(response)
                                });
                                rzp1.open();
                                
                            }
                        }

                    })
                })
                function paymentFailed(response){
                    $.ajax({
                        url:'/paymentFailed',
                        data:response,
                        method:'post',
                        success:(response)=>{
                          if(response.status){
                            
                                Swal.fire({
                                    title: 'Payment Failed !',
                                    icon: 'error',
                                    showDenyButton: true,
                                    confirmButtonText: 'View Order',
                                    denyButtonText: `Continue Shopping`,
                                    toast: true,
                                }).then((result) => {
                                    /* Read more about isConfirmed, isDenied below */
                                    if (result.isConfirmed) {
                                        location.href = '/orders'
                                    } else if (result.isDenied) {
                                        location.href = '/'
                                    }
                                }) 
                            
                          }  
                        }
                    })
                }
                function verifyPayment(payment,razorpayOrderData,userOrderData){
                    
                    $.ajax({
                        url:'/verifyPayment',
                        data:{
                            payment,
                            razorpayOrderData,
                            userOrderData
                        },
                        method:'post',
                        success:(response)=>{
                            if(response.status){
                                Swal.fire({
                                    title: 'Order Placed Successfully',
                                    icon: 'success',
                                    showDenyButton: true,
                                    confirmButtonText: 'View Order',
                                    denyButtonText: `Continue Shopping`,
                                    toast: true,
                                }).then((result) => {
                                    /* Read more about isConfirmed, isDenied below */
                                    if (result.isConfirmed) {
                                        location.href = '/orders'
                                    } else if (result.isDenied) {
                                        location.href = '/'
                                    }
                                }) 
                            }
                        }
                        
                    })
                }


            </script>
           <% } %>